{% extends 'base.html' %}

{% block title %}Crear Reporte - SIGEPRO{% endblock %}

{% block content %}
<div class="container">
    <h1>Crear Reporte</h1>
    <form action="{{ url_for('crear_reporte') }}" method="post" enctype="multipart/form-data">
        <div class="input-field">
            <select name="contrato" id="contrato" onchange="loadTalleres()">
                <option value="" disabled selected>Seleccione un proyecto</option>
                {% for proyecto in proyectos %}
                    <option value="{{ proyecto['Contrato'] }}">{{ proyecto['Oferente'] }} - {{ proyecto['Contrato'] }}</option>
                {% endfor %}
            </select>
            <label for="contrato">Seleccione un Proyecto:</label>
        </div>

        <div class="input-field">
            <select name="id_taller" id="taller">
                <option value="" disabled selected>Seleccione un taller</option>
            </select>
            <label for="taller">Seleccione un Taller:</label>
        </div>

        <div class="input-field">
            <input type="date" name="fecha_reporte" id="fecha_reporte" required>
            <label for="fecha_reporte">Fecha del Reporte:</label>
        </div>

        <div class="input-field">
            <textarea name="descripcion" id="descripcion" class="materialize-textarea" required></textarea>
            <label for="descripcion">Descripción:</label>
        </div>

        <div class="input-field">
            <select name="estatus" id="estatus" required>
                <option value="" disabled selected>Seleccione el estatus</option>
                <option value="No Iniciada">No Iniciada</option>
                <option value="Activa">Activa</option>
                <option value="Detenida - Falta de pago">Detenida - Falta de pago</option>
                <option value="Detenida">Detenida</option>
                <option value="Notificado">Notificado</option>
                <option value="Terminado">Terminado</option>
            </select>
            <label for="estatus">Estatus:</label>
        </div>

        <div class="input-field">
            <input type="number" name="porciento_eje" id="porciento_eje" required>
            <label for="porciento_eje">Porciento de Ejecución:</label>
        </div>

        <div>
            <label for="imagen_1">Imagen 1:</label>
            <input type="file" name="imagen_1" id="imagen_1" required><br>
            <label for="imagen_2">Imagen 2:</label>
            <input type="file" name="imagen_2" id="imagen_2" required><br>
            <label for="imagen_3">Imagen 3:</label>
            <input type="file" name="imagen_3" id="imagen_3" required><br>
            <label for="imagen_4">Imagen 4:</label>
            <input type="file" name="imagen_4" id="imagen_4" required><br>
        </div>

        <button type="submit" class="btn">Crear Reporte</button>
    </form>
</div>

<script src="{{ url_for('static', filename='materialize.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var selectElems = document.querySelectorAll('select');
        var instances = M.FormSelect.init(selectElems);
    });

    function loadTalleres() {
        const contrato = document.getElementById('contrato').value;
        if (!contrato) {
            document.getElementById('taller').innerHTML = '<option value="" disabled selected>Seleccione un taller</option>';
            return;
        }

        fetch(`/talleres_por_contrato/${contrato}`)
            .then(response => response.json())
            .then(data => {
                const tallerSelect = document.getElementById('taller');
                tallerSelect.innerHTML = '<option value="" disabled selected>Seleccione un taller</option>';
                data.forEach(taller => {
                    const option = document.createElement('option');
                    option.value = taller.ID_Talleres;
                    option.textContent = `${taller.Lote} - ${taller.Item}`;
                    tallerSelect.appendChild(option);
                });
                M.FormSelect.init(tallerSelect);
            });
    }
</script>
{% endblock %}
